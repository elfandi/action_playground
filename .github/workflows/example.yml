name: test examples

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  examples:
    name: ${{ matrix.examples }} example for pg${{ matrix.version }}
    runs-on: ${{ matrix.os }}
    if: "!contains(github.event.head_commit.message, 'nogha')"

    strategy:
      matrix:
        version: [10, 11, 12, 13]
        os: ["ubuntu-latest"]
        examples: ["arrays", "bad_ideas", "bgworker", "bytea", "custom_types", "errors", "operators", "schemas", "shmem", "spi", "srf", "strings"]

    steps:
    - uses: actions/checkout@v2

    - name: cargo version
      run: cargo --version

    # Ubuntu system dependencies for Postgres
    - name: remove old postgres
      run: sudo apt remove -y postgres*

    # Update apt
    - name: update apt
      run: sudo apt-get update -y -qq --fix-missing
    - name: postgres apt repo
      run: sudo apt-get install -y wget gnupg
    - name: install postgres apt repo
      run: echo "deb http://apt.postgresql.org/pub/repos/apt/ focal-pgdg main" | sudo tee -a /etc/apt/sources.list.d/pgdg.list
    - name: post postgres apt repo update apt
      run: sudo apt-get update -y -qq --fix-missing
